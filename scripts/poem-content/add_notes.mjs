/*
ã€ä¸€ã€è„šæœ¬ç”¨é€”è¯´æ˜ã€‘

è¯¥è„šæœ¬ç”¨äºè‡ªåŠ¨ä¸ºå¤è¯—æ–‡çš„ full.json æ–‡ä»¶ç”Ÿæˆæ³¨é‡Šã€‚æ¯ä¸€é¦–å¤è¯—æ–‡çš„ç›®å½•ä¸‹éœ€è¦æ”¾ç½®ä¸€ä¸ª notes.mdx æ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­åŒ…å«æ‰€æœ‰æ³¨é‡Šå†…å®¹ã€‚è„šæœ¬ä¼šè‡ªåŠ¨è¯»å– notes.mdxï¼Œè§£æå…¶ä¸­çš„æ³¨é‡Šï¼Œå°†å…¶è½¬æ¢æˆç»“æ„åŒ–çš„æ³¨é‡Šæ•°æ®ï¼Œå¹¶å†™å…¥å¯¹åº”çš„ full.json æ–‡ä»¶ã€‚åŸæ¥çš„æ³¨é‡Šä¼šå…¨éƒ¨æ¸…ç©ºå¹¶è¢«æ›¿æ¢ä¸ºæ–°çš„æ³¨é‡Šã€‚

è„šæœ¬ä¼šè‡ªåŠ¨éå† junior ä¸ senior ä¸¤ä¸ªç‰ˆæœ¬ä¸‹çš„å¤è¯—æ–‡ç›®å½•ï¼Œå¯¹æ¯ä¸€ä¸ªè¯—æ–‡æ–‡ä»¶å¤¹æ‰§è¡Œæ³¨é‡Šå†™å…¥æ“ä½œã€‚å¦‚æœç›®å½•ä¸­æ²¡æœ‰ notes.mdx æ–‡ä»¶ï¼Œåˆ™è·³è¿‡è¯¥è¯—æ–‡ï¼Œä¸è¿›è¡Œä¿®æ”¹ã€‚

â¸»

ã€äºŒã€notes.mdx çš„ä¹¦å†™æ ¼å¼è¦æ±‚ã€‘

Notes æ–‡ä»¶é‡‡ç”¨è¡Œçº§æ³¨é‡Šæ ¼å¼ï¼Œæ¯ä¸€è¡Œè¡¨ç¤ºä¸€æ¡æ³¨é‡Šã€‚

æ¯æ¡æ³¨é‡Šå¿…é¡»åŒ…å«ä¸¤éƒ¨åˆ†å†…å®¹ï¼š
    1.	æ–¹æ‹¬å·å†…çš„â€œè¢«æ³¨é‡Šè¯è¯­â€ï¼Œå¯ä»¥åŒ…å«æ±‰å­—ä¸æ‹¼éŸ³ï¼Œä½†è„šæœ¬ä¼šè‡ªåŠ¨å»é™¤æ‹¼éŸ³ã€‚
    2.	æ–¹æ‹¬å·åçš„æ³¨é‡Šè§£é‡Šæ–‡æœ¬ã€‚

åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š
[è¯è¯­æˆ–è¯ç»„ï¼ˆæ‹¼éŸ³ï¼‰]æ³¨é‡Šå†…å®¹

è¯´æ˜ï¼š
ï¼ˆ1ï¼‰æ–¹æ‹¬å·å¿…é¡»æˆå¯¹å‡ºç°ã€‚
ï¼ˆ2ï¼‰æ–¹æ‹¬å·ä¸­å¯ä»¥å‡ºç°ä¸€ä¸ªæˆ–å¤šä¸ªè¯è¯­ï¼Œè¯è¯­ä¹‹é—´å¯ç”¨é¡¿å·ã€é€—å·ç­‰å¸¸è§åˆ†éš”ç¬¦åˆ†éš”ã€‚
ï¼ˆ3ï¼‰æ‹¬å·ä¸­çš„æ‹¼éŸ³ä¼šè‡ªåŠ¨ç§»é™¤ï¼Œä¸å½±å“åŒ¹é…ã€‚
ï¼ˆ4ï¼‰æ–¹æ‹¬å·åé¢çš„æ–‡å­—å…¨éƒ¨è¢«è§†ä¸ºæ³¨é‡Šå†…å®¹ï¼Œä¸åšåˆ†éš”å¤„ç†ã€‚
ï¼ˆ5ï¼‰æ¯ä¸€æ¡æ³¨é‡Šå¿…é¡»ç‹¬å ä¸€è¡Œã€‚
ï¼ˆ6ï¼‰å¦‚æœ‰ç©ºè¡Œï¼Œå°†è¢«è‡ªåŠ¨å¿½ç•¥ã€‚

ç¤ºä¾‹ï¼š
[é’é’å­è¡¿ï¼ˆjÄ«nï¼‰ï¼Œæ‚ æ‚ æˆ‘å¿ƒ]è¯­å‡ºã€Šè¯—ç»Â·éƒ‘é£Â·å­è¡¿ã€‹ï¼Œç”¨äºå†™æ€å¿µä¹‹æƒ…ã€‚
[å¥‘é˜”è°ˆè®Œï¼ˆyÃ nï¼‰]æ„ä¸ºä¹…åˆ«é‡é€¢åçš„ç•…é¥®ä¸äº¤è°ˆã€‚

â¸»

ã€ä¸‰ã€æ³¨é‡Šä¸ full.json çš„å¯¹åº”å…³ç³»ã€‘

è„šæœ¬ä¼šæ ¹æ® notes.mdx ä¸­çš„â€œè¯è¯­â€å†…å®¹ï¼Œè‡ªåŠ¨æ‰¾åˆ°è¯¥è¯è¯­åœ¨ full.json ä¸­å¯¹åº”å¥å­çš„å­—ç¬¦èŒƒå›´ã€‚

full.json ä¸­æ¯ä¸ªå¥å­ç”± content å­—æ®µæä¾›é€å­—ä¿¡æ¯ï¼Œæ¯ä¸ªå­—æœ‰ä¸€ä¸ª indexã€‚è„šæœ¬é€šè¿‡å¥å†…å­—åºåˆ—æŸ¥æ‰¾è¯è¯­èµ·ç‚¹ä¸ç»ˆç‚¹ä½ç½®ï¼Œå¹¶å°†ç»“æœå†™å…¥ notes å­—æ®µã€‚

ç”Ÿæˆçš„æ³¨é‡Šæ ¼å¼å¦‚ä¸‹ï¼š
startï¼šè¯è¯­åœ¨è¯¥å¥å­ä¸­ç¬¬ä¸€ä¸ªå­—çš„ index
endï¼šè¯è¯­åœ¨è¯¥å¥å­ä¸­æœ€åä¸€ä¸ªå­—çš„ index
contentï¼šæ³¨é‡Šæ–‡æœ¬ï¼ˆæ¥è‡ªæ–¹æ‹¬å·åçš„å†…å®¹ï¼‰

ä¾‹å¦‚ï¼š
è¯è¯­â€œå¯¹é…’å½“æ­Œâ€åœ¨å¥å­ä¸­ä½äºç¬¬ 0 è‡³ç¬¬ 3 ä¸ªå­—ï¼Œåˆ™æ³¨é‡Šå†™ä¸ºï¼š
start = 0
end = 3

è„šæœ¬ä¼šå°†æ¯ä¸ªå¥å­çš„ notes æ•°ç»„å…¨éƒ¨æ¸…ç©ºï¼Œç„¶åå†™å…¥æ–°çš„æ³¨é‡Šã€‚

â¸»

ã€å››ã€è„šæœ¬çš„å·¥ä½œæµç¨‹ã€‘

ï¼ˆä¸€ï¼‰è·å–è„šæœ¬æ‰€åœ¨ä½ç½®ï¼Œå¹¶å®šä½ poem/junior ä¸ poem/senior çš„æ•°æ®ç›®å½•ã€‚
ï¼ˆäºŒï¼‰éå†æ¯ä¸ªè¯—æ–‡çš„æ–‡ä»¶å¤¹ã€‚
ï¼ˆä¸‰ï¼‰æ£€æŸ¥è¯¥æ–‡ä»¶å¤¹æ˜¯å¦åŒ…å« full.jsonã€‚
ï¼ˆå››ï¼‰æ£€æŸ¥æ˜¯å¦å­˜åœ¨ notes.mdxï¼Œè‹¥æ²¡æœ‰åˆ™è·³è¿‡è¯¥è¯—æ–‡ã€‚
ï¼ˆäº”ï¼‰è¯»å– full.jsonï¼Œå¹¶æ¸…ç©ºåŸæœ‰ notes å­—æ®µã€‚
ï¼ˆå…­ï¼‰è¯»å– notes.mdxï¼Œå°†æ¯ä¸€è¡Œè§£ææˆï¼šå…³é”®è¯åˆ—è¡¨ä¸æ³¨é‡Šå†…å®¹ã€‚
ï¼ˆä¸ƒï¼‰å¯¹æ¯ä¸ªå…³é”®è¯æœç´¢æ‰€å±è¯—æ–‡ä¸­çš„å¥å­ï¼Œæ‰¾åˆ°å¯¹åº”çš„å­—ç¬¦èŒƒå›´ã€‚
ï¼ˆå…«ï¼‰å°†æ³¨é‡Šå†™å…¥è¯¥å¥å­çš„ notes å­—æ®µã€‚
ï¼ˆä¹ï¼‰å°†ä¿®æ”¹åçš„ full.json å†™å›åŸä½ç½®ã€‚
ï¼ˆåï¼‰ç»§ç»­å¤„ç†ä¸‹ä¸€é¦–è¯—æ–‡ã€‚

â¸»

ã€äº”ã€æ“ä½œæ–¹å¼ã€‘

ï¼ˆä¸€ï¼‰ç¡®ä¿è„šæœ¬æ–‡ä»¶ add_notes.mjs ä½äº scripts ç›®å½•ä¸‹çš„ poem-content å­ç›®å½•ä¸­ã€‚
ï¼ˆäºŒï¼‰ç¡®ä¿é¡¹ç›®ä½¿ç”¨ Node.js è¿è¡Œç¯å¢ƒã€‚
ï¼ˆä¸‰ï¼‰åœ¨ç»ˆç«¯è¿›å…¥é¡¹ç›®æ ¹ç›®å½•ã€‚
ï¼ˆå››ï¼‰æ‰§è¡Œå‘½ä»¤ï¼š
node scripts/poem-content/add_notes.mjs
ï¼ˆäº”ï¼‰è„šæœ¬å°†è‡ªåŠ¨å¤„ç†æ‰€æœ‰è¯—æ–‡ï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®šè·¯å¾„ã€‚
ï¼ˆå…­ï¼‰å¤„ç†å®Œæˆåï¼Œä¼šåœ¨ç»ˆç«¯è¾“å‡ºæˆåŠŸæˆ–è·³è¿‡çš„ä¿¡æ¯ã€‚

â¸»

ã€å…­ã€æ³¨æ„äº‹é¡¹ã€‘
    1.	notes.mdx ä¸­çš„æ³¨é‡Šå¿…é¡»ä¸€è¡Œä¸€æ¡ï¼Œæ–¹æ‹¬å·å¿…é¡»å®Œæ•´é—­åˆã€‚
    2.	æ³¨é‡Šä¸­çš„æ‹¼éŸ³ä¼šè¢«è‡ªåŠ¨æ¸…é™¤ï¼Œä¸å½±å“åŒ¹é…ã€‚
    3.	åŒä¸€æ¡æ³¨é‡Šä¸­çš„å¤šä¸ªè¯è¯­ä¼šè¢«è§†ä¸ºå¤šä¸ªç‹¬ç«‹æ³¨é‡Šï¼Œåˆ†åˆ«å†™å…¥ full.jsonã€‚
    4.	å…³é”®è¯å¿…é¡»èƒ½å¤Ÿåœ¨å¥å­ä¸­å®Œæ•´å‡ºç°ï¼Œå¦åˆ™ä¸ä¼šå†™å…¥ã€‚
    5.	è‹¥æŸäº›è¯è¯­æ— æ³•åŒ¹é…ä»»ä½•å¥å­ï¼Œè„šæœ¬ä¸ä¼šæŠ¥é”™ï¼Œä½†ä¹Ÿä¸ä¼šå†™å…¥æ³¨é‡Šã€‚
    6.	full.json ä¼šè¢«ç›´æ¥è¦†ç›–ï¼Œè¯·é¿å…åœ¨è„šæœ¬è¿è¡ŒæœŸé—´æ‰‹åŠ¨ä¿®æ”¹ full.jsonã€‚
    7.	è„šæœ¬ä¸ä¼šç”Ÿæˆ preview.jsonç­‰æ–‡ä»¶ï¼ŒåŠŸèƒ½ä»…é™æ³¨é‡Šå†™å…¥ full.jsonã€‚
*/

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);



const versions = ["junior", "senior"];

/**
 * è¯—æ–‡è¿‡æ»¤åˆ—è¡¨ï¼š
 * è‹¥æŸç‰ˆæœ¬æ•°ç»„ä¸ºç©ºï¼Œåˆ™å¤„ç†è¯¥ç‰ˆæœ¬å…¨éƒ¨è¯—æ–‡ï¼›
 * è‹¥æ•°ç»„éç©ºï¼Œåˆ™åªå¤„ç†æ•°ç»„å†…æŒ‡å®šçš„è¯—æ–‡æ–‡ä»¶å¤¹åç§°ã€‚
 */
const poemList = {
    junior: [],
    senior: ["å…¼çˆ±"]
};

/**
 * æ”¯æŒå‚æ•°ï¼š --list=junior,senior
 * è‹¥æä¾›è¯¥å‚æ•°ï¼Œåˆ™åªå¤„ç†æŒ‡å®šçš„ç‰ˆæœ¬
 */
let useList = false;
let enableLog = false;

for (const arg of process.argv.slice(2)) {
    if (arg === "--list") {
        useList = true;
        console.log("ğŸ“Œ å·²å¯ç”¨ list æ¨¡å¼ï¼Œå°†åªæŒ‰ poemList è¿‡æ»¤å¤„ç†è¯—æ–‡");
    }
    if (arg === "--log") {
        enableLog = true;
        console.log("ğŸ“˜ å·²å¯ç”¨ log æ¨¡å¼");
    }
}

// å·¥å…·ï¼šç§»é™¤æ‹¼éŸ³ï¼ˆæ‹¬å·ä¸­çš„å†…å®¹ï¼‰
function removePinyin(str) {
    return str.replace(/ï¼ˆ.*?ï¼‰/g, "");
}

// å·¥å…·ï¼šæå–æ±‰å­—
function extractChinese(str) {
    return str.replace(/[^\u4e00-\u9fa5]/g, "");
}

// åŒ¹é…å…³é”®è¯ä½ç½®
function findKeywordInSentence(sentenceContent, keyword) {
    const chars = sentenceContent.map(c => c.char).join('');
    const idx = chars.indexOf(keyword);
    if (idx === -1) return null;
    return {
        start: idx,
        end: idx + keyword.length - 1
    };
}

for (const version of versions) {
    const basePath = path.join(__dirname, "../../src/data/poem", version);
    if (!fs.existsSync(basePath)) continue;

    const poemDirs = fs.readdirSync(basePath);
    let targetPoemDirs = poemDirs;
    if (useList && poemList[version] && poemList[version].length > 0) {
        targetPoemDirs = poemDirs.filter(name => poemList[version].includes(name));
        console.log(`ğŸ“„ list æ¨¡å¼ï¼šç‰ˆæœ¬ ${version} ä»…å¤„ç†ï¼š`, targetPoemDirs);
    }

    for (const dir of targetPoemDirs) {
        const poemPath = path.join(basePath, dir);
        const fullJsonPath = path.join(poemPath, "full.json");
        const notesPath = path.join(poemPath, "notes.mdx");

        if (!fs.existsSync(fullJsonPath)) continue;
        if (!fs.existsSync(notesPath)) {
            // console.log(`è·³è¿‡ï¼š${dir}`);
            continue;
        }

        try {
            const full = JSON.parse(fs.readFileSync(fullJsonPath, "utf-8"));
            const originalJson = JSON.stringify(full, null, 2);
            const notesText = fs.readFileSync(notesPath, "utf-8").trim();

            // è§£æ notes.mdx
            const notesList = notesText.split("\n").map(line => {
                const match = line.match(/\[(.*?)\](.*)/);
                if (!match) return null;

                const rawInside = match[1];
                const content = match[2].trim();

                // å…ˆå»æ‰æ‹¼éŸ³ï¼Œæ•´æ®µå†…å®¹è§†ä¸ºä¸€ä¸ªè¿ç»­çš„å…³é”®è¯ï¼ˆä¿ç•™å…¶ä¸­çš„æ ‡ç‚¹ï¼‰
                const noPinyin = removePinyin(rawInside);
                const keyword = noPinyin.trim();
                const keywords = keyword.length ? [keyword] : [];

                return { keywords, content };
            }).filter(Boolean);

            // æ¸…ç©ºåŸ notes
            for (const para of full.paragraphs) {
                for (const sentence of para.sentences) {
                    sentence.notes = [];
                }
            }

            let lastGlobalIndex = -1;

            for (const { keywords, content } of notesList) {
                // æ¯æ¡æ³¨é‡Šåªå…è®¸æ·»åŠ ä¸€æ¬¡
                let annotationFound = false;

                for (const kw of keywords) {
                    if (annotationFound) break;

                    for (const para of full.paragraphs) {
                        if (annotationFound) break;

                        for (const sentence of para.sentences) {
                            const pos = findKeywordInSentence(sentence.content, kw);
                            if (!pos) continue;

                            // å°†å¥å†…å±€éƒ¨ index æ˜ å°„åˆ°å…¨æ–‡ global index
                            const globalStart = sentence.content[pos.start].index;

                            // åªèƒ½åŒ¹é…åœ¨ä¸Šä¸€ä¸ªæ³¨é‡Šä¹‹åçš„ä½ç½®
                            if (globalStart <= lastGlobalIndex) continue;

                            if (enableLog) {
                                console.log("ğŸ” åŒ¹é…åˆ°æ³¨é‡Šï¼š", content);
                                console.log("ğŸ”‘ å…³é”®è¯ï¼š", kw);
                                console.log("ğŸ“ å…¨æ–‡èµ·å§‹ indexï¼š", globalStart);
                                console.log("ğŸ“ æ‰€åœ¨å¥å­ï¼š", sentence.content.map(c => c.char).join(''));
                                console.log("-----");
                            }
                            sentence.notes.push({
                                start: pos.start,
                                end: pos.end,
                                content
                            });

                            // è®°å½•æœ¬æ¡æ³¨é‡Šçš„å…¨æ–‡ç»“æŸä½ç½®
                            lastGlobalIndex = sentence.content[pos.end].index;

                            annotationFound = true;
                            break;
                        }
                    }
                }
            }

            // æ¯”è¾ƒä¿®æ”¹åçš„å†…å®¹ä¸åŸå†…å®¹
            const newJson = JSON.stringify(full, null, 2);
            if (newJson !== originalJson) {
                fs.writeFileSync(fullJsonPath, newJson);
                console.log(`ğŸ”„ æ›´æ–°ï¼š${dir}`);
            }

        } catch (e) {
            console.error(`âŒ å¤„ç† ${fullJsonPath} å‡ºé”™ï¼š`, e);
        }
    }
}